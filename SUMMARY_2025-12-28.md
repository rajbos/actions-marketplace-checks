# Summary: Why Over 3,000 Repos Were Removed from Status File

## Quick Answer
The workflow run removed over 3,000 repos because PR #113 introduced a bug that corrupted the status.json file by saving simplified display objects instead of full repository objects.

## What Happened in Workflow Run #20555604985

### The Workflow
- **Name**: Cleanup Invalid Repos
- **Run ID**: 20555604985
- **Trigger**: Manual dispatch with `dryRun=false`
- **Date**: December 28, 2025 at 15:10 UTC
- **Result**: Success (but with unintended data loss)

### The Sequence of Events

1. **Download status.json** - Downloaded from blob storage (~29MB with ~29,279 repos)

2. **Scan for Invalid Entries** - The `GetReposToCleanup` function found:
   - Invalid entries (null/empty names, owner="_", etc.)
   - Repos with null/empty owners that needed fixing
   - Repos eligible for cleanup (upstream missing/deleted)

3. **Early Status File Save** - Because invalid entries or owner fixes were found, the function saved status.json immediately (lines 209-219 or 221-232)

4. **THE BUG** - When building the array to save:
   ```powershell
   $validCombined = @()
   $validCombined += $validStatus           # Full objects ✓
   $validCombined += $reposToCleanup        # Simplified objects ✗ BUG!
   ```

5. **Data Corruption** - Repos eligible for cleanup were saved as simplified 4-property objects:
   - **Kept**: name, owner, reason, upstreamFullName
   - **Lost**: repoSize, tagInfo, releaseInfo, upstreamFound, upstreamAvailable, mirrorFound, etc.

6. **Upload to Blob** - Corrupted status.json uploaded to blob storage

7. **Subsequent Impact** - The corrupted file caused issues in processing

## Why This Affected 3,000+ Repos

The workflow run that triggered this:
1. Had a significant number of repos that were eligible for cleanup (upstreamFound=false or upstreamAvailable=false)
2. ALL of these repos lost their metadata when converted to simplified objects
3. The corrupted data made it impossible to properly process these repos
4. Subsequent cleanup operations removed them because they appeared invalid or couldn't be properly evaluated

## The Numbers

Based on the workflow summary, the likely breakdown was:
- **Original status count**: ~29,000+ repos
- **Repos eligible for cleanup**: ~3,000+ (upstream missing/deleted)
- **Invalid entries found**: Unknown number, but enough to trigger the save
- **Final result**: These 3,000+ repos were converted to 4-property objects, losing all metadata

## The Fix

We implemented a fix that separates display objects from persistence objects:

**Before (Buggy)**:
```powershell
$reposToCleanup = New-Object System.Collections.ArrayList  # Simplified for display

# Later when saving:
$validCombined += $reposToCleanup  # BUG: Simplified objects in status file!
```

**After (Fixed)**:
```powershell
$reposToCleanup = New-Object System.Collections.ArrayList  # Simplified for display
$reposToCleanupFullObjects = New-Object System.Collections.ArrayList  # Full objects

# When a repo should be cleaned:
$reposToCleanup.Add(@{ name, owner, reason, upstreamFullName })  # For display
$reposToCleanupFullObjects.Add($repo)  # For persistence (full object)

# Later when saving:
$validCombined += $reposToCleanupFullObjects  # FIX: Full objects preserved!
```

## Impact Assessment

### Data Loss
- **Type**: Metadata loss for repos eligible for cleanup
- **Severity**: High (lost tracking information)
- **Recoverability**: High (can be rebuilt from upstream sources)

### Prevention
- ✅ Separated display structures from persistence structures
- ✅ Added test coverage for status file integrity
- ✅ Added explicit comments documenting the separation
- ✅ Created incident report for future reference

## Verification

All tests pass with the fix:
- ✅ 26 cleanup-related tests
- ✅ 3 new status file integrity tests
- ✅ 5 RemoveReposFromStatus tests
- ✅ 9 owner extraction tests

## Recommendation

Before the next cleanup run:
1. Review the current status.json file to assess the extent of corruption
2. Consider restoring from a backup if available
3. Run with `dryRun=true` first to validate the fix
4. Monitor the next actual run closely

## Related Files
- Fix: `.github/workflows/cleanup-invalid-repos.ps1`
- Tests: `tests/cleanup-status-file-integrity.Tests.ps1`
- Full Incident Report: `INCIDENT_REPORT_2025-12-28.md`
