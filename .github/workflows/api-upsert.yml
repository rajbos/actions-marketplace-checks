# Upload action data to alternative marketplace API
name: Upload to API

on:
  workflow_dispatch:
    inputs:
      numberOfRepos:
        description: 'Number of repos to upload'
        required: false
        default: '50'
        type: string

  push:
    paths:
      - .github/workflows/api-upsert.yml
      - .github/workflows/api-upsert.ps1
      - .github/workflows/node-scripts/src/*.js

  schedule:
    - cron: '*/15 * * * *'

jobs:
  upload-to-api:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@devops-actions'

      - name: Download status.json from blob storage
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Get-StatusFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to download status.json from blob storage"
            exit 1
          }

      - name: Install npm package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.DEVOPS_ACTIONS_PACKAGE_DOWNLOAD }}
        run: |
          npm install @devops-actions/actions-marketplace-client

      - shell: pwsh
        name: Upload actions to API
        env:
          AZ_FUNCTION_URL: ${{ vars.AZ_FUNCTION_URL }}
          AZ_FUNCTION_TOKEN: ${{ secrets.AZ_FUNCTION_TOKEN }}
          NUMBER_OF_REPOS: ${{ inputs.numberOfRepos }}
        run: |
          try {
            # Clean BOM if present before parsing JSON
            $jsonContent = Get-Content status.json -Raw
            $jsonContent = $jsonContent -replace '^\uFEFF', ''  # Remove UTF-8 BOM (Unicode)
            $status = $jsonContent | ConvertFrom-Json
          } catch {
            Write-Host "=== STATUS.JSON PARSE ERROR ==="
            Write-Host "JSON parsing failed: $($_.Exception.Message)"
            Write-Host "First 10 lines of status.json:"
            Get-Content status.json | Select-Object -First 10 | ForEach-Object { Write-Host $_ }
            try { $filePath = Resolve-Path status.json -ErrorAction Stop } catch { $filePath = "$PWD/status.json" }
            Write-Host "See the file at: $filePath"
            Write-Host "Stopping workflow with exit 1 due to parse failure."
            Write-Host "==============================="
            exit 1
          }
          
          Write-Host "Found [$($status.Length)] entries in status.json"
          
          # Load library for Write-Message
          . ./.github/workflows/library.ps1
          
          # Run the upload script
          if ([string]::IsNullOrWhiteSpace($env:NUMBER_OF_REPOS)) {
            # Use default from script (5) when no input was provided (e.g. push trigger)
            ./.github/workflows/api-upsert.ps1 -status $status -apiUrl $env:AZ_FUNCTION_URL -functionKey $env:AZ_FUNCTION_TOKEN
          } else {
            ./.github/workflows/api-upsert.ps1 -status $status -numberOfRepos $env:NUMBER_OF_REPOS -apiUrl $env:AZ_FUNCTION_URL -functionKey $env:AZ_FUNCTION_TOKEN
          }
