name: Cleanup Invalid Repos
on:
  workflow_dispatch:
    inputs:
      numberOfReposToDo:
        description: 'Number of repos to cleanup'
        required: false
        default: '10'
      dryRun:
        description: 'Dry run (true/false)'
        required: false
        default: 'true'

  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
    
jobs:
  cleanup-invalid-repos:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to commit and push changes to status.json
    steps:
      - uses: actions/checkout@v5

      - name: Download status.json from blob storage
        run: |
          curl "${{ secrets.BLOB_SAS_TOKEN_STATUS }}" > status.json
          echo "Downloaded status.json"
          ls -lh status.json
          
      - shell: pwsh
        name: Run cleanup script
        run: |
           ./.github/workflows/cleanup-invalid-repos.ps1 -numberOfReposToDo ${{ github.event.inputs.numberOfReposToDo || '10' }} -access_token "${{ secrets.ACCESS_TOKEN }}" -dryRun $${{ github.event.inputs.dryRun || 'true' }}

      - name: Upload status.json to blob storage
        if: github.event.inputs.dryRun != 'true'
        env:
          AZURE_STORAGE_SAS_TOKEN: ${{ secrets.BLOB_SAS_TOKEN_STATUS_WRITE }}
        run: |
          # Upload status.json back to blob storage
          curl -X PUT -T status.json -H "x-ms-blob-type: BlockBlob" "${{ secrets.BLOB_SAS_TOKEN_STATUS_WRITE }}"
          echo "Uploaded status.json to blob storage"

