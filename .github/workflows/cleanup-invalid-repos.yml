name: Cleanup Invalid Repos
on:
  workflow_dispatch:
    inputs:
      numberOfReposToDo:
        description: 'Number of repos to cleanup'
        required: false
        default: '10'
      dryRun:
        description: 'Dry run (true/false)'
        required: false
        default: 'true'

  schedule:
    - cron: '0 2 * * *'

  push:
    paths: 
      - .github/workflows/cleanup-invalid-repos.yml    
      - .github/workflows/cleanup-invalid-repos.ps1
    
jobs:
  cleanup-invalid-repos:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to commit and push changes to status.json
    steps:
      - uses: actions/checkout@v6

      - name: Download status.json from blob storage
        run: |
          # Extract base URL and construct status.json URL
          # BLOB_SAS_TOKEN points to the /data container, we need /data/status/status.json
          baseUrl="${{ secrets.BLOB_SAS_TOKEN }}"
          # Remove the query string to get base path
          basePath=$(echo "$baseUrl" | cut -d'?' -f1)
          # Get the SAS query
          sasQuery=$(echo "$baseUrl" | cut -d'?' -f2-)
          # Construct the full URL for status.json
          statusUrl="${basePath}/status/status.json?${sasQuery}"
          
          # Download with -f flag to fail on HTTP errors (404, 403, etc.)
          # -S flag shows error messages even when silent
          if ! curl -fS "$statusUrl" > status.json; then
            echo "❌ ERROR: Failed to download status.json from blob storage"
            echo "**❌ ERROR: Failed to download status.json from blob storage**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "Downloaded status.json"
          ls -lh status.json
          
          # Validate file size - must be bigger than 5 bytes
          fileSize=$(stat -c%s status.json)
          echo "File size: $fileSize bytes"
          if [ "$fileSize" -le 5 ]; then
            echo "❌ ERROR: Downloaded status.json is too small ($fileSize bytes). File may be corrupted or empty."
            echo "**❌ ERROR: Downloaded status.json is too small ($fileSize bytes). File may be corrupted or empty.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "✓ status.json size validation passed ($fileSize bytes)"

      - name: Setup parameters based on trigger
        id: setup
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "numberOfReposToDo=100" >> $GITHUB_OUTPUT
            echo "dryRun=false" >> $GITHUB_OUTPUT
            echo "Running on schedule: numberOfReposToDo=100, dryRun=false"
          else
            echo "numberOfReposToDo=${{ github.event.inputs.numberOfReposToDo || '10' }}" >> $GITHUB_OUTPUT
            echo "dryRun=${{ github.event.inputs.dryRun || 'true' }}" >> $GITHUB_OUTPUT
            echo "Running manually: numberOfReposToDo=${{ github.event.inputs.numberOfReposToDo || '10' }}, dryRun=${{ github.event.inputs.dryRun || 'true' }}"
          fi

      - name: Get App Token
        id: get_workflow_token
        uses: rajbos-actions/workflow-application-token-action@v3.0.0
        with:
          application_id: 264650
          application_private_key: ${{ secrets.Automation_App_Key }}
          organization: actions-marketplace-validations
          
      - shell: pwsh
        name: Run cleanup script
        run: |
           ./.github/workflows/cleanup-invalid-repos.ps1 -numberOfReposToDo ${{ steps.setup.outputs.numberOfReposToDo }} -access_token "${{ steps.get_workflow_token.outputs.token }}" -dryRun $${{ steps.setup.outputs.dryRun }}

      - name: Upload status.json to blob storage
        if: steps.setup.outputs.dryRun != 'true'
        run: |
          # Validate file size before upload - must be bigger than 5 bytes
          if [ ! -f status.json ]; then
            echo "❌ ERROR: status.json file not found. Cannot upload."
            echo "**❌ ERROR: status.json file not found. Cannot upload.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          fileSize=$(stat -c%s status.json)
          echo "File size to upload: $fileSize bytes"
          if [ "$fileSize" -le 5 ]; then
            echo "❌ ERROR: status.json is too small ($fileSize bytes). Refusing to upload empty or corrupted file."
            echo "**❌ ERROR: status.json is too small ($fileSize bytes). Refusing to upload empty or corrupted file.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "✓ status.json size validation passed ($fileSize bytes)"
          
          # Count repos in the file
          repoCount=$(jq '. | length' status.json)
          echo "Repo count: $repoCount"
          
          # Format file size for display
          if [ "$fileSize" -ge 1048576 ]; then
            # Convert to MB
            fileSizeMB=$(echo "scale=2; $fileSize / 1048576" | bc)
            fileSizeFormatted="${fileSizeMB} MB"
          elif [ "$fileSize" -ge 1024 ]; then
            # Convert to KB
            fileSizeKB=$(echo "scale=2; $fileSize / 1024" | bc)
            fileSizeFormatted="${fileSizeKB} KB"
          else
            fileSizeFormatted="${fileSize} bytes"
          fi
          echo "Formatted file size: $fileSizeFormatted"
          
          # Upload status.json back to blob storage using the same SAS token
          baseUrl="${{ secrets.BLOB_SAS_TOKEN }}"
          basePath=$(echo "$baseUrl" | cut -d'?' -f1)
          sasQuery=$(echo "$baseUrl" | cut -d'?' -f2-)
          statusUrl="${basePath}/status/status.json?${sasQuery}"
          curl -X PUT -T status.json -H "x-ms-blob-type: BlockBlob" "$statusUrl"
          echo "Uploaded status.json to blob storage"
          
          # Format repo count with thousands separator
          repoCountFormatted=$(LC_NUMERIC=en_US.UTF-8 printf "%'d" $repoCount)
          
          # Write upload summary to step summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Upload Status File Information" >> $GITHUB_STEP_SUMMARY
          echo "**Uploaded status.json:**" >> $GITHUB_STEP_SUMMARY
          echo "- Total repos in file: **${repoCountFormatted}**" >> $GITHUB_STEP_SUMMARY
          echo "- File size: **${fileSizeFormatted}**" >> $GITHUB_STEP_SUMMARY


