name: Get actions that use the OSS Scan action

on:
  push: 
    branches: 
      - main
    paths:
      - .github/workflows/ossf-scan.yml
      - .github/workflows/ossf-scan.ps1

  schedule:
     - cron: '50 3 * * *'

  workflow_dispatch:

env:
  APP_ID: ${{ vars.APPLICATION_ID }}
  APP_ID_2: ${{ vars.APPLICATION_ID_2 }}
  APP_ID_3: ${{ vars.APPLICATION_ID_3 }}
  APP_ORGANIZATION: actions-marketplace-validations

jobs:
  get-data:
    concurrency:
      group: repo-state-updates
      cancel-in-progress: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Download status.json from blob storage
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Get-StatusFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to download status.json from blob storage"
            exit 1
          }

      - name: Download failedForks.json from blob storage
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Get-FailedForksFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to download failedForks.json from blob storage"
            exit 1
          }
          
      - shell: pwsh
        name: Run reporting script
        env:
          APPLICATION_PRIVATE_KEY: ${{ secrets.AUTOMATION_APP_KEY }}
          APPLICATION_PRIVATE_KEY_2: ${{ secrets.AUTOMATION_APP_KEY2 }}
          APPLICATION_PRIVATE_KEY_3: ${{ secrets.AUTOMATION_APP_KEY3 }}
        run: |
           # Debug: Show first 10 lines of status.json
           Write-Host "First 10 lines of status.json:"
           Get-Content status.json -TotalCount 10 | ForEach-Object { Write-Host $_ }

           # Clean BOM if present before parsing JSON
           $jsonContent = Get-Content status.json -Raw
           $jsonContent = $jsonContent -replace '^\uFEFF', ''  # Remove UTF-8 BOM (Unicode)
           try {
             $actions = $jsonContent | ConvertFrom-Json
           } catch {
             Write-Host "ERROR: JSON parsing failed"
             Write-Host "First 10 lines of content:"
             Get-Content status.json -TotalCount 10 | ForEach-Object { Write-Host $_ }
             throw $_
           }

           Write-Host "Found [$($actions.Length)] actions in the datafile"
           # $numberOfReposToDo = $actions.Length
           $numberOfReposToDo = 1000

           & "${{ github.workspace }}/.github/workflows/ossf-scan.ps1" -actions $actions -numberOfReposToDo $numberOfReposToDo -logSummary "$($env:GITHUB_STEP_SUMMARY)"

      - name: Upload status.json to blob storage
        if: always()
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Set-StatusToBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to upload status.json to blob storage"
            exit 1
          }

      - name: Upload failedForks.json to blob storage
        if: always()
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Set-FailedForksToBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to upload failedForks.json to blob storage"
            exit 1
          }
