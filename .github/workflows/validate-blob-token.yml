# Validate Azure Blob Storage SAS Token
# This workflow tests all blob storage download operations to ensure the token is valid
name: Validate Blob Token

on:
  workflow_dispatch:

  pull_request: 

  push:
  
  schedule:
    # Run daily at 1 AM UTC to catch token expiration issues early
    - cron: '0 1 * * *'

jobs:
  validate-blob-access:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Validate BLOB_SAS_TOKEN secret exists
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          if ([string]::IsNullOrWhiteSpace($env:BLOB_SAS_TOKEN)) {
            Write-Error "‚ùå BLOB_SAS_TOKEN secret is not set or is empty"
            exit 1
          }
          Write-Host "‚úÖ BLOB_SAS_TOKEN secret is configured"
          
          # Validate it looks like a SAS URL at blob storage level
          if ($env:BLOB_SAS_TOKEN -notmatch '^https://.*\?.*') {
            Write-Error "‚ùå BLOB_SAS_TOKEN does not appear to be a valid SAS URL (should start with https:// and contain a query string)"
            exit 1
          }
          Write-Host "‚úÖ BLOB_SAS_TOKEN format looks valid (blob storage base URL with SAS query)"

      - name: Test download actions.json (base file)
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          Write-Host "Testing download of actions.json (base file)..."
          
          $result = Get-ActionsJsonFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "‚ùå Failed to download actions.json from blob storage"
            exit 1
          }
          
          # Validate the downloaded file
          if (Test-Path $actionsFile) {
            $fileSize = (Get-Item $actionsFile).Length
            Write-Host "‚úÖ Successfully downloaded actions.json ($fileSize bytes)"
            
            # Validate it's valid JSON
            try {
              $json = Get-Content $actionsFile -Raw | ConvertFrom-Json
              Write-Host "‚úÖ actions.json is valid JSON"
              
              if ($json.Count -gt 0) {
                Write-Host "‚úÖ actions.json contains $($json.Count) items"
              } else {
                Write-Warning "‚ö†Ô∏è actions.json is empty"
              }
            } catch {
              Write-Error "‚ùå actions.json is not valid JSON: $($_.Exception.Message)"
              exit 1
            }
          } else {
            Write-Error "‚ùå actions.json not found at expected location: $actionsFile"
            exit 1
          }

      - name: Test download status.json
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          Write-Host "Testing download of status.json..."
          
          $result = Get-StatusFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "‚ùå Failed to download status.json from blob storage"
            exit 1
          }
          
          # Validate the downloaded file
          if (Test-Path $statusFile) {
            $fileSize = (Get-Item $statusFile).Length
            Write-Host "‚úÖ Successfully downloaded status.json ($fileSize bytes)"
            
            # Validate it's valid JSON
            try {
              $jsonContent = Get-Content $statusFile -Raw
              $jsonContent = $jsonContent -replace '^\uFEFF', ''  # Remove UTF-8 BOM
              $json = $jsonContent | ConvertFrom-Json
              Write-Host "‚úÖ status.json is valid JSON"
              
              if ($json.Count -gt 0) {
                Write-Host "‚úÖ status.json contains $($json.Count) items"
              } else {
                Write-Warning "‚ö†Ô∏è status.json is empty (might be new deployment)"
              }
            } catch {
              Write-Error "‚ùå status.json is not valid JSON: $($_.Exception.Message)"
              exit 1
            }
          } else {
            Write-Error "‚ùå status.json not found at expected location: $statusFile"
            exit 1
          }

      - name: Test download failedForks.json
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          Write-Host "Testing download of failedForks.json..."
          
          $result = Get-FailedForksFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "‚ùå Failed to download failedForks.json from blob storage"
            exit 1
          }
          
          # Validate the downloaded file
          if (Test-Path $failedStatusFile) {
            $fileSize = (Get-Item $failedStatusFile).Length
            Write-Host "‚úÖ Successfully downloaded failedForks.json ($fileSize bytes)"
            
            # Validate it's valid JSON
            try {
              $json = Get-Content $failedStatusFile -Raw | ConvertFrom-Json
              Write-Host "‚úÖ failedForks.json is valid JSON"
              
              if ($json.Count -gt 0) {
                Write-Host "‚úÖ failedForks.json contains $($json.Count) items"
              } else {
                Write-Host "‚úÖ failedForks.json is empty (no failed forks)"
              }
            } catch {
              Write-Error "‚ùå failedForks.json is not valid JSON: $($_.Exception.Message)"
              exit 1
            }
          } else {
            Write-Error "‚ùå failedForks.json not found at expected location: $failedStatusFile"
            exit 1
          }

      - name: Test blob URL construction
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          Write-Host "Testing blob URL construction logic..."
          
          # Parse the SAS token URL (blob storage level)
          $baseUrlWithQuery = $env:BLOB_SAS_TOKEN
          $queryStart = $baseUrlWithQuery.IndexOf('?')
          
          if ($queryStart -eq -1) {
            Write-Error "‚ùå BLOB_SAS_TOKEN does not contain a query string (no '?' found)"
            exit 1
          }
          
          $baseUrl = $baseUrlWithQuery.Substring(0, $queryStart)
          $sasQuery = $baseUrlWithQuery.Substring($queryStart)
          
          Write-Host "Blob Storage Base URL: $baseUrl"
          Write-Host "Query string length: $($sasQuery.Length) characters"
          Write-Host "‚úÖ SAS token is at blob storage level"
          
          # Test constructing file URLs by appending full paths
          $actionsJsonUrl = "${baseUrl}/data/actions.json${sasQuery}"
          Write-Host "‚úÖ Constructed actions.json URL: ${baseUrl}/data/actions.json (SAS redacted)"
          
          # Expected files and their constructed URLs
          $expectedFiles = @(
            @{Name='data/actions.json'; Path="${baseUrl}/data/actions.json${sasQuery}"},
            @{Name='data/status/status.json'; Path="${baseUrl}/data/status/status.json${sasQuery}"},
            @{Name='data/status/failedForks.json'; Path="${baseUrl}/data/status/failedForks.json${sasQuery}"},
            @{Name='data/status/secretScanningAlerts.json'; Path="${baseUrl}/data/status/secretScanningAlerts.json${sasQuery}"}
          )
          
          Write-Host "‚úÖ Can construct URLs for all expected files:"
          foreach ($file in $expectedFiles) {
            $displayPath = $file.Path -replace '\?.*$', ' (SAS redacted)'
            Write-Host "   - $($file.Name): $displayPath"
          }

      - name: Summary
        if: success()
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "================================================"
          Write-Host "üéâ All blob storage validation checks passed!"
          Write-Host "================================================"
          Write-Host ""
          Write-Host "Validated files:"
          Write-Host "  ‚úÖ data/actions.json"
          Write-Host "  ‚úÖ data/status/status.json"
          Write-Host "  ‚úÖ data/status/failedForks.json"
          Write-Host ""
          Write-Host "The BLOB_SAS_TOKEN is valid and all download operations work correctly."
