# Fork new action repos
# Get new data from Dependabot
# Store the data in Azure Blob Storage

name: Analyze

on:
  push:
    paths:
      - .github/workflows/analyze.yml
      - .github/workflows/functions.ps1

  schedule:
     #- cron: '*/60 * * * *'
     - cron: '1 */1 * * *'

  workflow_dispatch:

env:
  numberOfReposToDo: 75
  numberOfReposToDoRepoInfo: 75

jobs:
  check-em-all:
    concurrency:
      group: repo-state-updates
      cancel-in-progress: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Get current actions list
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          Write-Host "Downloading actions.json from Azure Blob Storage..."
          
          # The BLOB_SAS_TOKEN should be the full URL to actions.json
          $sasToken = $env:BLOB_SAS_TOKEN
          
          # Debug: show URL structure (without signature)
          $queryStart = $sasToken.IndexOf('?')
          if ($queryStart -gt 0) {
              $baseUrl = $sasToken.Substring(0, $queryStart)
              Write-Host "Base URL (redacted): $baseUrl"
              Write-Host "URL length: $($sasToken.Length)"
          }
          
          try {
              Invoke-WebRequest -Uri $sasToken -Method GET -OutFile "actions.json" -UseBasicParsing | Out-Null
              
              if (Test-Path "actions.json") {
                  $fileSize = (Get-Item "actions.json").Length
                  Write-Host "Successfully downloaded actions.json ($fileSize bytes)"
                  
                  # Show first 10 lines
                  Write-Host ""
                  Write-Host "Content of the file (first 10 lines):"
                  Get-Content "actions.json" -TotalCount 10 | ForEach-Object { Write-Host $_ }
              }
              else {
                  Write-Error "Failed to download actions.json - file not found after download"
                  exit 1
              }
          }
          catch {
              Write-Host "ERROR: Failed to download actions.json"
              Write-Host "Exception: $($_.Exception.Message)"
              if ($_.Exception.Response) {
                  Write-Host "Status Code: $($_.Exception.Response.StatusCode)"
              }
              exit 1
          }

      - name: Download status.json from blob storage
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Get-StatusFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to download status.json from blob storage"
            exit 1
          }

      - name: Download failedForks.json from blob storage
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Get-FailedForksFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to download failedForks.json from blob storage"
            exit 1
          }

      - name: Get App Token
        id: get_workflow_token2
        uses: rajbos-actions/workflow-application-token-action@v3.0.0
        with:
          application_id: 264650
          application_private_key: ${{ secrets.Automation_App_Key }}
          organization: actions-marketplace-validations

      - shell: pwsh
        name: "Gotta check 'em all: functions"
        run: |
           # Debug: Show first 10 lines of actions.json
           Write-Host "First 10 lines of actions.json:"
           Get-Content actions.json -TotalCount 10 | ForEach-Object { Write-Host $_ }
           
           # Clean BOM if present before parsing JSON
           $jsonContent = Get-Content actions.json -Raw
           $jsonContent = $jsonContent -replace '^\uFEFF', ''  # Remove UTF-8 BOM (Unicode)
           try {
               $actions = $jsonContent | ConvertFrom-Json
           } catch {
               Write-Host "ERROR: JSON parsing failed"
               Write-Host "First 10 lines of content:"
               Get-Content actions.json -TotalCount 10 | ForEach-Object { Write-Host $_ }
               throw $_
           }
           Write-Host "Found [$($actions.Length)] actions in the datafile"
           Install-Module -Name PSGraphQL -Repository PSGallery -Scope CurrentUser -Allowclobber -Force
           Install-Module -name powershell-yaml -Force -Repository PSGallery -Scope CurrentUser -Allowclobber

           # fork repos and load Dependabot status
           # used to be secrets.ACCESS_TOKEN, but that expired. trying with app token
           ./.github/workflows/functions.ps1 -actions $actions -numberOfReposToDo ${{ env.numberOfReposToDo }} -access_token "${{ steps.get_workflow_token2.outputs.token }}" -access_token_destination ${{ steps.get_workflow_token2.outputs.token }}

      # get a new token for the next script, as it might have expired already
      - name: Get App Token
        id: get_workflow_token
        uses: rajbos-actions/workflow-application-token-action@v3.0.0
        with:
          application_id: 264650
          application_private_key: ${{ secrets.Automation_App_Key }}
          organization: actions-marketplace-validations

      - shell: pwsh
        name: "Gotta check 'em all: repoInfo"
        run: |
           # Debug: Show first 10 lines of actions.json
           Write-Host "First 10 lines of actions.json:"
           Get-Content actions.json -TotalCount 10 | ForEach-Object { Write-Host $_ }
           
           # Clean BOM if present before parsing JSON
           $jsonContent = Get-Content actions.json -Raw
           $jsonContent = $jsonContent -replace '^\uFEFF', ''  # Remove UTF-8 BOM (Unicode)
           try {
               $actions = $jsonContent | ConvertFrom-Json
           } catch {
               Write-Host "ERROR: JSON parsing failed"
               Write-Host "First 10 lines of content:"
               Get-Content actions.json -TotalCount 10 | ForEach-Object { Write-Host $_ }
               throw $_
           }
           Write-Host "Found [$($actions.Length)] actions in the datafile"

           # get repo information
           # used to be secrets.ACCESS_TOKEN, but that expired. trying with app token
           ${{ github.workspace }}/.github/workflows/repoInfo.ps1 -actions $actions -numberofReposToDo ${{ env.numberOfReposToDoRepoInfo }} -access_token "${{ steps.get_workflow_token.outputs.token }}" -access_token_destination ${{ steps.get_workflow_token.outputs.token }}

      - name: Upload status.json to blob storage
        if: always()
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Set-StatusToBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to upload status.json to blob storage"
            exit 1
          }

      - name: Upload failedForks.json to blob storage
        if: always()
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Set-FailedForksToBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to upload failedForks.json to blob storage"
            exit 1
          }
