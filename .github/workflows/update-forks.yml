# Update all mirrored repos to sync with their upstream repositories
name: Update Mirrors

on:
  push:
    paths:
      - .github/workflows/update-forks.yml
      - .github/workflows/update-forks.ps1

  schedule:
    - cron: '*/15 * * * *'

  workflow_dispatch:
    inputs:
      numberOfRepos:
        description: 'Number of repos to update (default: 100)'
        required: false
        default: '100'

env: 
  numberOfReposToDo: 300

jobs:
  update-forks:
    concurrency:
      group: repo-state-updates
      cancel-in-progress: false
    runs-on: ubuntu-latest
    permissions:
      actions: read    # Required to read workflow artifacts
    steps:
      - uses: actions/checkout@v6

      - name: Download status.json from blob storage
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          # FATAL ERROR: If status.json cannot be downloaded, the workflow cannot proceed
          . ./.github/workflows/library.ps1
          $result = Get-StatusFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to download status.json from blob storage - this is a fatal error"
            exit 1
          }

      - name: Download failedForks.json from blob storage
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          # FATAL ERROR: If failedForks.json cannot be downloaded, the workflow cannot proceed
          . ./.github/workflows/library.ps1
          $result = Get-FailedForksFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to download failedForks.json from blob storage - this is a fatal error"
            exit 1
          }

      - name: Get App Token
        id: get_workflow_token
        uses: rajbos-actions/workflow-application-token-action@v3.0.0
        with:
          application_id: 264650
          application_private_key: ${{ secrets.Automation_App_Key }}
          organization: actions-marketplace-validations
          
      - shell: pwsh
        name: Update mirrored repos
        run: |
           try {
               # Clean BOM if present before parsing JSON
               $jsonContent = Get-Content status.json -Raw
               $jsonContent = $jsonContent -replace '^\uFEFF', ''  # Remove UTF-8 BOM (Unicode)
               $existingForks = $jsonContent | ConvertFrom-Json
           } catch {
               Write-Host "=== STATUS.JSON PARSE ERROR (FATAL) ==="
               Write-Host "JSON parsing failed: $($_.Exception.Message)"
               Write-Host "First 10 lines of status.json:"
               Get-Content status.json | Select-Object -First 10 | ForEach-Object { Write-Host $_ }
               try { $filePath = Resolve-Path status.json -ErrorAction Stop } catch { $filePath = "$PWD/status.json" }
               Write-Host "See the file at: $filePath"
               Write-Host "Stopping workflow with exit 1 due to fatal parse failure."
               Write-Host "==============================="
               exit 1
           }
           Write-Host "Found [$($existingForks.Length)] mirrors in the status file"
           
           # Use workflow input if available, otherwise use env variable
           $numberOfRepos = ${{ github.event.inputs.numberOfRepos || env.numberOfReposToDo }}
           Write-Host "Will process up to [$numberOfRepos] repos in this run"
           
           # Execute the update script
           # Note: Per-mirror git errors are logged as warnings and do NOT cause exit 1
           # Only fatal script errors (missing files, unrecoverable errors) will cause exit 1
           try {
               ./.github/workflows/update-forks.ps1 -actions $existingForks -numberOfReposToDo $numberOfRepos -access_token "${{ steps.get_workflow_token.outputs.token }}" -access_token_destination "${{ steps.get_workflow_token.outputs.token }}"
               Write-Host "Mirror sync script completed successfully"
           } catch {
               Write-Host "=== FATAL ERROR IN MIRROR SYNC SCRIPT ==="
               Write-Host "Error: $($_.Exception.Message)"
               Write-Host "Stack trace: $($_.ScriptStackTrace)"
               Write-Host "This is a fatal error - exiting with code 1"
               Write-Host "=========================================="
               exit 1
           }

      - name: Upload failed forks artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: failed-forks
          path: failedForks.json
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload status.json to blob storage
        if: always()
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Set-StatusToBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Warning "Failed to upload status.json to blob storage"
            # Don't exit 1 here - we want to continue to upload failedForks.json
          } else {
            Write-Host "Successfully uploaded status.json to blob storage"
          }

      - name: Upload failedForks.json to blob storage
        if: always()
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Set-FailedForksToBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Warning "Failed to upload failedForks.json to blob storage"
            # Don't exit 1 here - we still want the workflow to complete
          } else {
            Write-Host "Successfully uploaded failedForks.json to blob storage"
          }
