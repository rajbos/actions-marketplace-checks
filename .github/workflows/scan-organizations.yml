# Scan multiple GitHub organizations for available actions
# Uses devops-actions/load-available-actions to scan orgs
# Consolidates results into a single file matching actions.json format

name: Scan Organizations

on:
  push:
    paths:
      - .github/workflows/scan-organizations.yml

  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'

  workflow_dispatch:
    inputs:
      organizations:
        description: 'Comma-separated list of orgs to scan (default: github,actions,advanced-security,dependabot)'
        required: false
        default: 'github,actions,advanced-security,dependabot'

env:
  DEFAULT_ORGS: 'github,actions,advanced-security,dependabot'

jobs:
  prepare:
    name: Prepare organization matrix
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set matrix
        id: set-matrix
        shell: pwsh
        run: |
          # Use workflow input if available, otherwise use default
          $orgsString = "${{ github.event.inputs.organizations }}"
          if ([string]::IsNullOrWhiteSpace($orgsString)) {
            $orgsString = "${{ env.DEFAULT_ORGS }}"
          }
          
          # Split into array and create matrix JSON
          $orgs = $orgsString -split ',' | ForEach-Object { $_.Trim() } | Where-Object { -not [string]::IsNullOrWhiteSpace($_) }
          $matrixJson = ConvertTo-Json -InputObject $orgs -Compress
          
          Write-Host "Organizations to scan: $matrixJson"
          "matrix=$matrixJson" >> $env:GITHUB_OUTPUT

  scan-org:
    name: Scan ${{ matrix.org }}
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        org: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v6

      - name: Load available actions for ${{ matrix.org }}
        id: load-actions
        uses: devops-actions/load-available-actions@v2.1.17
        with:
          organization: ${{ matrix.org }}

      - name: Save actions to file
        shell: pwsh
        run: |
          $actions = '${{ steps.load-actions.outputs.actions }}' | ConvertFrom-Json
          Write-Host "Found $($actions.Count) actions for organization '${{ matrix.org }}'"
          
          # Save to file
          $actions | ConvertTo-Json -Depth 10 -Compress | Out-File -FilePath "${{ matrix.org }}.json" -Encoding UTF8
          
          # Show file size
          $fileSize = (Get-Item "${{ matrix.org }}.json").Length
          Write-Host "Created file ${{ matrix.org }}.json ($fileSize bytes)"

      - name: Upload org actions to blob storage
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          
          $result = Set-JsonToBlobStorageFolder `
            -sasToken $env:BLOB_SAS_TOKEN `
            -folderPath "organization-scans" `
            -blobFileName "${{ matrix.org }}.json" `
            -localFilePath "${{ matrix.org }}.json"
          
          if (-not $result) {
            Write-Error "Failed to upload ${{ matrix.org }}.json to blob storage"
            exit 1
          }

      - name: Upload artifact for consolidation
        uses: actions/upload-artifact@v4
        with:
          name: org-scan-${{ matrix.org }}
          path: ${{ matrix.org }}.json
          retention-days: 1

  consolidate:
    name: Consolidate organization scans
    needs: [prepare, scan-org]
    if: success() || failure()
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Download all organization scans
        uses: actions/download-artifact@v4
        with:
          pattern: org-scan-*
          path: org-scans/
          merge-multiple: true

      - name: Consolidate all organization scans
        shell: pwsh
        run: |
          . ./.github/workflows/library.ps1
          
          Write-Message -message "# Consolidating Organization Scans" -logToSummary $true
          Write-Message -message "" -logToSummary $true
          
          # Find all org scan files
          $orgFiles = Get-ChildItem -Path "org-scans" -Filter "*.json" -ErrorAction SilentlyContinue
          
          # Get expected organizations
          $expectedOrgs = '${{ needs.prepare.outputs.matrix }}' | ConvertFrom-Json
          Write-Message -message "Expected organizations: $($expectedOrgs -join ', ')" -logToSummary $true
          Write-Message -message "" -logToSummary $true
          
          if (-not $orgFiles -or $orgFiles.Count -eq 0) {
            Write-Warning "No organization scan files found to consolidate"
            Write-Message -message "⚠️ No organization scan files found. Expected $($expectedOrgs.Count) organizations." -logToSummary $true
            exit 1
          }
          
          if ($orgFiles.Count -lt $expectedOrgs.Count) {
            Write-Warning "Found only $($orgFiles.Count) of $($expectedOrgs.Count) expected organization scans"
            Write-Message -message "⚠️ Found only $($orgFiles.Count) of $($expectedOrgs.Count) expected organization scans" -logToSummary $true
          }
          
          Write-Message -message "Found $($orgFiles.Count) organization scan files to consolidate" -logToSummary $true
          Write-Message -message "" -logToSummary $true
          
          # Consolidate all actions into a single array
          $allActions = @()
          $actionsByOrg = @{}
          
          foreach ($file in $orgFiles) {
            $orgName = $file.BaseName
            Write-Host "Processing $orgName from $($file.Name)..."
            
            try {
              $jsonContent = Get-Content $file.FullName -Raw
              # Remove BOM only if present
              if ($jsonContent -match '^\uFEFF') {
                $jsonContent = $jsonContent -replace '^\uFEFF', ''
              }
              $orgActions = $jsonContent | ConvertFrom-Json
              
              if ($orgActions) {
                $actionCount = if ($orgActions -is [array]) { $orgActions.Count } else { 1 }
                Write-Message -message "- **$orgName**: $actionCount actions" -logToSummary $true
                $actionsByOrg[$orgName] = $actionCount
                
                # Add all actions to the consolidated array
                if ($orgActions -is [array]) {
                  $allActions += $orgActions
                } else {
                  $allActions += @($orgActions)
                }
              }
            }
            catch {
              Write-Warning "Failed to process $orgName`: $($_.Exception.Message)"
            }
          }
          
          Write-Message -message "" -logToSummary $true
          Write-Message -message "**Total consolidated actions**: $(DisplayIntWithDots $allActions.Count)" -logToSummary $true
          Write-Message -message "" -logToSummary $true
          
          # Save consolidated file
          $consolidatedFile = "consolidated-github-actions.json"
          $allActions | ConvertTo-Json -Depth 10 | Out-File -FilePath $consolidatedFile -Encoding UTF8
          
          $fileSize = (Get-Item $consolidatedFile).Length
          $fileSizeFormatted = Format-FileSize -bytes $fileSize
          Write-Message -message "Created consolidated file: $consolidatedFile ($fileSizeFormatted)" -logToSummary $true

      - name: Upload consolidated file to blob storage
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          
          $result = Set-JsonToBlobStorageFolder `
            -sasToken $env:BLOB_SAS_TOKEN `
            -folderPath "organization-scans" `
            -blobFileName "consolidated-github-actions.json" `
            -localFilePath "consolidated-github-actions.json"
          
          if (-not $result) {
            Write-Error "Failed to upload consolidated-github-actions.json to blob storage"
            exit 1
          }
          
          Write-Message -message "" -logToSummary $true
          Write-Message -message "✓ Consolidation complete and uploaded to blob storage" -logToSummary $true

      - name: Upload consolidated artifact
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-github-actions
          path: consolidated-github-actions.json
          retention-days: 7
