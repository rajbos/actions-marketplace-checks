# Fork new action repos
# Get new data from Dependabot
# Store the data in Azure Blob Storage

name: Get repo info

on:
  push:
    paths:
      - .github/workflows/repoInfo.yml
      - .github/workflows/repoInfo.ps1

  schedule:
     #- cron: '*/60 * * * *'
     - cron: '20 */1 * * *'

  workflow_dispatch:

env:
  numberOfReposToDo: 100 
  APP_ID: ${{ vars.APPLICATION_ID }}
  APP_ID_2: ${{ vars.APPLICATION_ID_2 }}
  APP_ID_3: ${{ vars.APPLICATION_ID_3 }}
  APP_ORGANIZATION: actions-marketplace-validations

jobs:
  process-repo-info:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Get current actions list
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Get-ActionsJsonFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN -localFilePath "actions.json"
          if (-not $result) {
            Write-Error "Failed to download actions.json from blob storage"
            exit 1
          }
          
          Write-Host "First 10 lines of actions.json:"
          Get-Content "actions.json" -TotalCount 10 | ForEach-Object { Write-Host $_ }

      - uses: actions/upload-artifact@v6
        with:
          name: actions.json
          path: actions.json

      - name: Download status.json from blob storage
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Get-StatusFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to download status.json from blob storage"
            exit 1
          }

      - name: Download failedForks.json from blob storage
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Get-FailedForksFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to download failedForks.json from blob storage"
            exit 1
          }

      - shell: pwsh
        name: Gotta check 'em all
        env:
          APPLICATION_PRIVATE_KEY: ${{ secrets.AUTOMATION_APP_KEY }}
          APPLICATION_PRIVATE_KEY_2: ${{ secrets.AUTOMATION_APP_KEY2 }}
          APPLICATION_PRIVATE_KEY_3: ${{ secrets.AUTOMATION_APP_KEY3 }}
        run: |
           # Debug: Show first 10 lines of actions.json
           Write-Host "First 10 lines of actions.json:"
           Get-Content actions.json -TotalCount 10 | ForEach-Object { Write-Host $_ }
           
           # Clean BOM if present before parsing JSON
           $jsonContent = Get-Content actions.json -Raw
           $jsonContent = $jsonContent -replace '^\uFEFF', ''  # Remove UTF-8 BOM (Unicode)
           try {
               $actions = $jsonContent | ConvertFrom-Json
           } catch {
               Write-Host "ERROR: JSON parsing failed"
               Write-Host "First 10 lines of content:"
               Get-Content actions.json -TotalCount 10 | ForEach-Object { Write-Host $_ }
               throw $_
           }
           Write-Host "Found [$($actions.Length)] actions in the datafile"
           Install-Module -Name PSGraphQL -Repository PSGallery -Scope CurrentUser -Allowclobber -Force
           Install-Module -name powershell-yaml -Force -Repository PSGallery -Scope CurrentUser -Allowclobber
           # get repo information
           & "${{ github.workspace }}/.github/workflows/repoInfo.ps1" -actions $actions -numberofReposToDo ${{ env.numberOfReposToDo }}

      - name: Upload updated status.json as artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: status-updated
          path: status.json
          retention-days: 1

      - name: Upload updated failedForks.json as artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: failedForks-updated
          path: failedForks.json
          retention-days: 1
          if-no-files-found: ignore

  upload-changes:
    name: Consolidate and upload changes to blob storage
    needs: process-repo-info
    if: always()
    runs-on: ubuntu-latest
    concurrency:
      group: repo-state-updates
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v6

      - name: Download latest status.json from blob storage
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Get-StatusFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to download status.json from blob storage"
            exit 1
          }

      - name: Download latest failedForks.json from blob storage
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Get-FailedForksFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to download failedForks.json from blob storage"
            exit 1
          }

      - name: Download updated status from previous job
        uses: actions/download-artifact@v7
        with:
          name: status-updated
          path: updated-data/

      - name: Download updated failedForks from previous job
        uses: actions/download-artifact@v7
        with:
          name: failedForks-updated
          path: updated-data/
        continue-on-error: true

      - name: Merge changes from processing job
        shell: pwsh
        run: |
          . ./.github/workflows/library.ps1

          Write-Message -message "# Consolidating Changes from Repo Info Processing" -logToSummary $true
          Write-Message -message "" -logToSummary $true

          # Load current status from blob storage
          try {
              $jsonContent = Get-Content status.json -Raw
              $jsonContent = $jsonContent -replace '^\uFEFF', ''
              $currentStatus = $jsonContent | ConvertFrom-Json
          } catch {
              Write-Error "Failed to parse current status.json: $($_.Exception.Message)"
              exit 1
          }

          Write-Message -message "Loaded current status from blob storage with [$(DisplayIntWithDots $currentStatus.Count)] forks" -logToSummary $true

          # Load updated status from processing job
          $updatedStatusFile = "updated-data/status.json"
          if (Test-Path $updatedStatusFile) {
              try {
                  $updatedContent = Get-Content $updatedStatusFile -Raw
                  $updatedContent = $updatedContent -replace '^\uFEFF', ''
                  $updatedStatus = $updatedContent | ConvertFrom-Json
                  Write-Message -message "Loaded updated status from processing job with [$(DisplayIntWithDots $updatedStatus.Count)] forks" -logToSummary $true
              } catch {
                  Write-Error "Failed to parse updated status.json: $($_.Exception.Message)"
                  exit 1
              }

              # Create hashtable for fast lookup
              $statusByName = @{}
              foreach ($item in $currentStatus) {
                  $statusByName[$item.name] = $item
              }

              # Merge updates - copy all properties from updated forks
              $mergeCount = 0
              foreach ($updatedFork in $updatedStatus) {
                  if ($statusByName.ContainsKey($updatedFork.name)) {
                      # Update existing entry - copy all properties from updated fork
                      $existing = $statusByName[$updatedFork.name]
                      
                      # Use PSObject.Properties for efficient property access
                      foreach ($prop in $updatedFork.PSObject.Properties) {
                          $propName = $prop.Name
                          $propValue = $prop.Value
                          
                          # Check if property exists using PSObject.Properties
                          $existingProp = $existing.PSObject.Properties[$propName]
                          if ($existingProp) {
                              $existingProp.Value = $propValue
                          } else {
                              $existing | Add-Member -Name $propName -Value $propValue -MemberType NoteProperty -Force
                          }
                      }
                      $mergeCount++
                  } else {
                      # Add new entry
                      $statusByName[$updatedFork.name] = $updatedFork
                      $mergeCount++
                  }
              }

              Write-Message -message "Merged [$(DisplayIntWithDots $mergeCount)] fork updates into current status" -logToSummary $true

              # Convert back to array and save
              $mergedStatus = $statusByName.Values
              Write-Message -message "Saving merged status with [$(DisplayIntWithDots $mergedStatus.Count)] forks" -logToSummary $true
              SaveStatus -existingForks $mergedStatus
          } else {
              Write-Message -message "No updated status.json found from processing job" -logToSummary $true
          }

          # Update failedForks if present
          $updatedFailedForksFile = "updated-data/failedForks.json"
          if (Test-Path $updatedFailedForksFile) {
              try {
                  $updatedFailedContent = Get-Content $updatedFailedForksFile -Raw
                  $updatedFailedContent = $updatedFailedContent -replace '^\uFEFF', ''
                  $updatedFailedForks = $updatedFailedContent | ConvertFrom-Json
                  
                  # Use the updated failedForks - it's based on the complete status processed by repoInfo.ps1
                  Write-Message -message "Using updated failedForks.json with [$(DisplayIntWithDots $updatedFailedForks.Count)] entries" -logToSummary $true
                  SaveStatus -failedForks $updatedFailedForks
              } catch {
                  Write-Warning "Failed to process updated failedForks.json: $($_.Exception.Message)"
              }
          }

          Write-Message -message "" -logToSummary $true
          Write-Message -message "‚úì Consolidation complete" -logToSummary $true

      - name: Setup Node.js for API updates
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@devops-actions'

      - name: Install npm package for API updates
        env:
          NODE_AUTH_TOKEN: ${{ secrets.DEVOPS_ACTIONS_PACKAGE_DOWNLOAD }}
        run: |
          npm install @devops-actions/actions-marketplace-client

      - name: Update API storage with consolidated data
        if: always()
        shell: pwsh
        env:
          AZ_FUNCTION_URL: ${{ vars.AZ_FUNCTION_URL }}
          AZ_FUNCTION_TOKEN: ${{ secrets.AZ_FUNCTION_TOKEN }}
        run: |
          . ./.github/workflows/library.ps1

          Write-Message -message "" -logToSummary $true
          Write-Message -message "## API Storage Update" -logToSummary $true
          Write-Message -message "" -logToSummary $true

          # Check if API credentials are available
          if ([string]::IsNullOrWhiteSpace($env:AZ_FUNCTION_URL) -or [string]::IsNullOrWhiteSpace($env:AZ_FUNCTION_TOKEN)) {
            Write-Message -message "‚ö†Ô∏è API credentials not available - skipping API update" -logToSummary $true
            exit 0
          }

          # Load the merged status
          try {
            $jsonContent = Get-Content status.json -Raw
            $jsonContent = $jsonContent -replace '^\uFEFF', ''
            $status = $jsonContent | ConvertFrom-Json
          } catch {
            Write-Message -message "‚ùå Failed to load status.json: $($_.Exception.Message)" -logToSummary $true
            exit 0
          }

          Write-Host "Uploading up to 100 actions to API storage..."

          # Call the API upsert function
          $numberOfRepos = 100
          $result = Invoke-ApiUpsert -status $status -apiUrl $env:AZ_FUNCTION_URL -functionKey $env:AZ_FUNCTION_TOKEN -numberOfRepos $numberOfRepos

          # Report results in step summary
          if ($result.error) {
            Write-Message -message "‚ö†Ô∏è API update encountered an error: $($result.error)" -logToSummary $true
          } else {
            $totalUpdates = $result.createdCount + $result.updatedCount
            Write-Message -message "| Status | Count |" -logToSummary $true
            Write-Message -message "|--------|------:|" -logToSummary $true
            Write-Message -message "| ‚úÖ Successful | $($result.successCount) |" -logToSummary $true
            Write-Message -message "| ‚ùå Failed | $($result.failCount) |" -logToSummary $true
            Write-Message -message "| üÜï Created | $($result.createdCount) |" -logToSummary $true
            Write-Message -message "| üìù Updated | $($result.updatedCount) |" -logToSummary $true
            Write-Message -message "| ‚è≠Ô∏è Skipped | $($result.skippedCount) |" -logToSummary $true
            Write-Message -message "" -logToSummary $true
            Write-Message -message "‚úì Total updates to API: **$totalUpdates** (created + updated)" -logToSummary $true
          }

          Write-Message -message "" -logToSummary $true

      - name: Upload status.json to blob storage
        if: always()
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Set-StatusToBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to upload status.json to blob storage"
            exit 1
          }

      - name: Upload failedForks.json to blob storage
        if: always()
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Set-FailedForksToBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to upload failedForks.json to blob storage"
            exit 1
          }

