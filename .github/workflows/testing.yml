name: Testing

on:

  push:
    branches:
      - main
    paths:
      - .github/workflows/testing.yml

  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Get App Token
        id: get_workflow_token
        uses: rajbos-actions/workflow-application-token-action@v3.0.0
        with:
          application_id: 264650
          application_private_key: ${{ secrets.Automation_App_Key }}
          organization: actions-marketplace-validations

      - shell: pwsh
        name: Run reporting script
        run: |
           try {
               # Clean BOM if present before parsing JSON
               $jsonContent = Get-Content status.json -Raw
               $jsonContent = $jsonContent -replace '^\uFEFF', ''  # Remove UTF-8 BOM (Unicode)
               $actions = $jsonContent | ConvertFrom-Json
           } catch {
               Write-Host "=== STATUS.JSON PARSE ERROR ==="
               Write-Host "JSON parsing failed: $($_.Exception.Message)"
               Write-Host "First 10 lines of status.json:"
               Get-Content status.json | Select-Object -First 10 | ForEach-Object { Write-Host $_ }
               Write-Host "See the file at: $(Resolve-Path status.json)"
               Write-Host "Stopping workflow with exit 1 due to parse failure."
               Write-Host "==============================="
               exit 1
           }
           Write-Host "Found [$($actions.Length)] actions in the datafile"

           . .github/workflows/library.ps1
           GetFoundSecretCount -access_token_destination $access_token_destination