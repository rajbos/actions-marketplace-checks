name: Run Pester tests

on:
  push:
    paths:
    - .github/workflows/*.ps1
    - .github/tests/*.ps1

defaults:
  run:
    shell: pwsh

jobs:
  pester-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Get current actions list
        shell: pwsh
        env:
          SAS: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          # The SAS token points to the 'data' folder: https://.../data?sas...
          # We need to construct URL for actions.json: https://.../data/actions.json?sas...
          $sasToken = $env:SAS
          $queryStart = $sasToken.IndexOf('?')
          $baseUrl = $sasToken.Substring(0, $queryStart)
          $sasQuery = $sasToken.Substring($queryStart)
          $actionsUrl = "$baseUrl/actions.json$sasQuery"
          
          Write-Host "Downloading actions.json from blob storage..."
          Invoke-WebRequest -Uri $actionsUrl -Method GET -OutFile "actions.json" -UseBasicParsing | Out-Null
      
      - name: Run Pester Tests
        run: Invoke-Pester -Output Detailed
