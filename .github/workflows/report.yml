# report the data stored in Azure Blob Storage
name: Generate report

on:

  push:
    paths:
      - .github/workflows/report.yml
      - .github/workflows/report.ps1

  schedule:
    - cron: '1 9 * * *'

  workflow_dispatch:

env:
  APP_ID: ${{ vars.APPLICATION_ID }}
  APP_ID_2: ${{ vars.APPLICATION_ID_2 }}
  APP_ORGANIZATION: actions-marketplace-validations

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Download status.json from blob storage
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Get-StatusFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to download status.json from blob storage"
            exit 1
          }

      - shell: pwsh
        name: Run reporting script
        env:
          APPLICATION_PRIVATE_KEY: ${{ secrets.AUTOMATION_APP_KEY }}
          APPLICATION_PRIVATE_KEY_2: ${{ secrets.AUTOMATION_APP_KEY2 }}
        run: |
           . ./.github/workflows/library.ps1
           try {
               # Clean BOM if present before parsing JSON
               $jsonContent = Get-Content status.json -Raw
               $jsonContent = $jsonContent -replace '^\uFEFF', ''  # Remove UTF-8 BOM (Unicode)
               $actions = $jsonContent | ConvertFrom-Json

               Write-Host "Normalizing date fields in status data..."
               $actions = Normalize-ActionDates -actions $actions
           } catch {
               Write-Host "=== STATUS.JSON PARSE ERROR ==="
               Write-Host "JSON parsing failed: $($_.Exception.Message)"
               Write-Host "First 10 lines of status.json:"
               Get-Content status.json | Select-Object -First 10 | ForEach-Object { Write-Host $_ }
               try { $filePath = Resolve-Path status.json -ErrorAction Stop } catch { $filePath = "$PWD/status.json" }
               Write-Host "See the file at: $filePath"
               Write-Host "Stopping workflow with exit 1 due to parse failure."
               Write-Host "==============================="
               exit 1
            }
            Write-Host "Found [$($actions.Length)] actions in the datafile"

            ./.github/workflows/report.ps1 -actions $actions -logSummary "$($env:GITHUB_STEP_SUMMARY)"

      - name: Upload secretScanningAlerts.json to blob storage
        if: always()
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Set-SecretScanningAlertsToBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to upload secretScanningAlerts.json to blob storage"
            exit 1
          }

      - uses: actions/upload-artifact@v6
        with:
          name: report
          path: VulnerableRepos-**.txt

      - uses: actions/upload-artifact@v6
        with:
          name: SecretScanningAlerts
          path: secretScanningAlerts.json
