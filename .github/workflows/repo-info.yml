# Fork new action repos
# Get new data from Dependabot
# Store the data in Azure Blob Storage

name: Get repo info

on:
  push:
    paths:
      - .github/workflows/repo-info.yml
      - .github/workflows/repoInfo.ps1

  schedule:
     #- cron: '*/60 * * * *'
     - cron: '20 */1 * * *'

  workflow_dispatch:

env:
  numberOfReposToDo: 50 # 100 repos often takes longer then an hour and then the access_token is no longer valid

jobs:
  get-repo-information:
    concurrency:
      group: repo-state-updates
      cancel-in-progress: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Get current actions list
        shell: pwsh
        env:
          SAS: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          # The SAS token points to the 'data' folder: https://.../data?sas...
          # We need to construct URL for actions.json: https://.../data/actions.json?sas...
          $sasToken = $env:SAS
          $queryStart = $sasToken.IndexOf('?')
          $baseUrl = $sasToken.Substring(0, $queryStart)
          $sasQuery = $sasToken.Substring($queryStart)
          $actionsUrl = "$baseUrl/actions.json$sasQuery"
          
          Write-Host "Downloading actions.json from blob storage..."
          Invoke-WebRequest -Uri $actionsUrl -Method GET -OutFile "actions.json" -UseBasicParsing | Out-Null

          $actions=(Get-Content actions.json | ConvertFrom-Json)

      - uses: actions/upload-artifact@v5
        with:
          name: actions.json
          path: actions.json

      - name: Download status.json from blob storage
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Get-StatusFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to download status.json from blob storage"
            exit 1
          }

      - name: Download failedForks.json from blob storage
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Get-FailedForksFromBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to download failedForks.json from blob storage"
            exit 1
          }

      - name: Get App Token
        id: get_workflow_token
        uses: rajbos-actions/workflow-application-token-action@v3.0.0
        with:
          application_id: 264650
          application_private_key: ${{ secrets.Automation_App_Key }}
          organization: actions-marketplace-validations

      - shell: pwsh
        name: Gotta check 'em all
        run: |
           $actions=(cat actions.json | ConvertFrom-Json)
           Write-Host "Found [$($actions.Length)] actions in the datafile"
           Install-Module -Name PSGraphQL -Repository PSGallery -Scope CurrentUser -Allowclobber -Force
           Install-Module -name powershell-yaml -Force -Repository PSGallery -Scope CurrentUser -Allowclobber
           # get repo information
           ${{ github.workspace }}/.github/workflows/repoInfo.ps1  -actions $actions -numberofReposToDo ${{ env.numberOfReposToDo }} -access_token "${{ secrets.ACCESS_TOKEN }}" -access_token_destination ${{ steps.get_workflow_token.outputs.token }}

      - name: Upload status.json to blob storage
        if: always()
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Set-StatusToBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to upload status.json to blob storage"
            exit 1
          }

      - name: Upload failedForks.json to blob storage
        if: always()
        shell: pwsh
        env:
          BLOB_SAS_TOKEN: "${{ secrets.BLOB_SAS_TOKEN }}"
        run: |
          . ./.github/workflows/library.ps1
          $result = Set-FailedForksToBlobStorage -sasToken $env:BLOB_SAS_TOKEN
          if (-not $result) {
            Write-Error "Failed to upload failedForks.json to blob storage"
            exit 1
          }
